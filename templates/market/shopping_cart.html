{% extends  'base.html' %}

{% load static %}

{% block main %}
<style>
    .product-list {
        margin-bottom: 40px;
        position: relative;
        width: 90%;
        left: 5%;
    }

    .product-list tr {
        padding: 5px;
        margin: 10px;
        min-height: 65px;
        display: flex;
        justify-content: space-around;
        align-items: center;
        border-radius: 10px;
        box-shadow: 0 0 2px 0 rgba(0,0,0,.1), 0 2px 6px 0 rgba(0,0,0,.1);
        -webkit-box-shadow: 0 0 2px 0 rgba(0,0,0,.1), 0 2px 6px 0 rgba(0,0,0,.1);
    }

    .active-products-list td,.active-products-list th {
        width: 20%;
        text-align: center;
    }

    .products-history td, .products-history th {
        width: 33%;
        text-align: center;
    }

    .dropdown-menu.show {
        display: flex;
        align-items: center;
        flex-direction: column;
    }
    .product-amount-btns input[type="button"] {
        background: white;
        border: 0;
        border-radius: 4px;
        box-shadow: 0 0 1px 0px #888;
        width: 30px;
    }
    
    .product-amount-btns input[type="button"]:active {
        background: #17a2b8;
    }

    .product-amount-btns input[type="number"] {
        appearance: textfield;
        max-width: 50px;
        text-align: center;
    }

    @media (max-width: 992px) {
        .product-list {
            width: 100%;
            left: 0;
        }

        .active-products-list td:nth-child(1), .active-products-list th:nth-child(1) {
            display: none;
        }

        .active-products-list td,.active-products-list th {
            width: 25%;
            flex-direction: column;
        }

        .product-check-list-operation-btn {
            width: 100%;
            margin: 5px 0 !important;
        }

        .product-check-list-operation-btn button {
            width: 100px;
            margin: 0;
        }
    }


</style>
    <h2 style="font-size: 40px;margin-top: 20px;" class="text-center">
        Корзина
    </h2>

    <div class="shopping-cart-body">
        {% if shopping_cart_items.len != 0 %}
            <table class="product-list active-products-list p-0">
                <thead class="text-center">
                    <tr style="box-shadow: 0 0 0 1px rgba(13,35,67,.07),0 5px 15px -4px rgba(13,35,67,.4);">
                        <th scope="col">Фото</th>
                        <th scope="col">Название товара</th>
                        <th scope="col">Количество</th>
                        <th scope="col">Цена за штуку</th>
                        <th scope="col">Стоимость</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in shopping_cart_items %}
                        <tr>
                            <td><img style="height: 70px;" src="{{ product.product.product_photo.url }}" alt="{{ product.product_name }}"></td>
                            <td>{{ product.product }}</td>
                            <td class="product-amount-btns">
                                <input type="button" class="amount-decrement" value="-">
                                <input type="number" class="input-number-products-amount" readonly min="0" data-value="{{ product.amount }}">
                                <input type="button" class="amount-increment" value="+">
                            </td>
                            <td>{{ product.product.price }} {{ product.product.plural_amount_name }}</td>
                            <td data-price-for-one-product="{{ product.product.price }}" data-product-id="{{ product.product.id }}" class="total-price-label">{% widthratio product.product.price 1 product.amount %} {{ product.product.plural_amount_name }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="row">
                <div class="col-12 d-flex justify-content-center">
                    <button type="button" class="btn btn-outline-success">Оформить заказ</button>
                </div>
            </div>
        {% else %}
        <h4 style="font-weight: 300;" class="text-center">
            Корзина пуста
        </h4>
        {% endif %}
    </div>


    <script>

    let CookieManager = {
        set: function (name, value, days) {
             let expires = "";
              if (days) {
                  let d = new Date();
                  d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
                  expires = "; expires=" + d.toGMTString();
              }
              document.cookie = name + "=" + value + expires + ";";
              return this.get(name);
        },
        get: function (name) {
              name += "=";
              let b = document.cookie.split(';'), c;
              for (var i = 0; i < b.length; i++) {
                  c = b[i].replace(/(^\s+)|(\s+$)/g, "");
                  while (c.charAt(0) == ' ')
                       c = c.substring(1, c.length);
                  if (c.indexOf(name) == 0)
                       return c.substring(name.length, c.length);
              }
              return null;
        },
        remove: function (name) {
              this.set(name, "", -1);
        }
    };

    function sendShoppingCartOperation(url) {
        let request = new XMLHttpRequest();
        url += ("&token=" + CookieManager.get("csrftoken"));
        request.open('GET', url);
        request.responseType = 'json';
        request.send();
        return request
    }

    function getCorrectNameForPoints (number) {
        if ((10 <= number % 100) && (number % 100 <= 20) || (number % 10 == 0) || (5 <= (number % 10)) && ((number % 10) <= 9)) {
            return "Баллов"
        } else if (number % 10 == 1) {
            return "Балл"
        }
        return "Балла"
    }


    let inputNumberProductsAmount = document.querySelectorAll(".input-number-products-amount");
    for (let i = 0; i < inputNumberProductsAmount.length; i++) {
        inputNumberProductsAmount[i].value = inputNumberProductsAmount[i].dataset.value;
    }

    let shoppingCartRow = document.querySelectorAll("tbody tr");

    for (let i = 0; i < shoppingCartRow.length; i++) {
        let amountButtons = shoppingCartRow[i].querySelector(".product-amount-btns"),
            totalPriceLabel = shoppingCartRow[i].querySelector(".total-price-label"),
            amountNumberInput = shoppingCartRow[i].querySelector("input[type='number']");

        const tempPrice = amountNumberInput.valueAsNumber * totalPriceLabel.dataset.priceForOneProduct;
            totalPriceLabel.textContent = tempPrice + ' ' + getCorrectNameForPoints(tempPrice);


        amountButtons.querySelector(".amount-decrement").onclick = function () {
            if (amountNumberInput.value - 1 === 0) {
                let request = sendShoppingCartOperation('http://127.0.0.1:8000/market/shopping-cart_operations/?remove_product=' + totalPriceLabel.dataset.productId);
                request.onload = function () {
                     if (request.response.message == "success") {
                         shoppingCartRow[i].parentNode.removeChild(shoppingCartRow[i]);
                         if (document.querySelectorAll("tbody tr").length == 0) {
                             document.querySelector('.shopping-cart-body').innerHTML = "<h4 style=\"font-weight: 300;\" class=\"text-center\"> Корзина пуста </h4>"
                         }
                     } else {
                         alert(request.response.message);
                     }
                }
            }
            else {
                let request = sendShoppingCartOperation('http://127.0.0.1:8000/market/shopping-cart_operations/?update_product=' + totalPriceLabel.dataset.productId + "&amount=" + (amountNumberInput.valueAsNumber - 1));
                request.onload = function () {
                    if (request.response.message == "success") {
                        amountNumberInput.value--;
                        const tempPrice = amountNumberInput.valueAsNumber * totalPriceLabel.dataset.priceForOneProduct;
                        totalPriceLabel.textContent = tempPrice + ' ' + getCorrectNameForPoints(tempPrice);
                    }
                }
            }
        }

        amountButtons.querySelector(".amount-increment").onclick = function () {
            let request = sendShoppingCartOperation('http://127.0.0.1:8000/market/shopping-cart_operations/?update_product=' + totalPriceLabel.dataset.productId + "&amount=" + (amountNumberInput.valueAsNumber + 1));
            request.onload = function () {
                if (request.response.message == "success") {
                     amountNumberInput.value++;
                     const tempPrice = amountNumberInput.valueAsNumber * totalPriceLabel.dataset.priceForOneProduct;
                     totalPriceLabel.textContent = tempPrice + ' ' + getCorrectNameForPoints(tempPrice);
                }
            }
        }

    }

    </script>

{% endblock %}
